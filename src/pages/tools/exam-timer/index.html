<!DOCTYPE html>
<html lang="ja" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Tailwind CSSのダークモードをクラスベースで有効化
      tailwind.config = {
        darkMode: 'class'
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* カスタムフォントの定義  数字はBIZ UDゴシックにした*/
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .font-digital {
            font-family: 'BIZ UD Gothic', sans-serif;
        }
        /* 時計の針のトランジション（ドラッグ中は無効化） */
        .hand-transition {
            transition: transform 0.2s cubic-bezier(.4,2.08,.55,.44);
        }
        /* 時計の文字盤の数字 */
        .clock-number {
            position: absolute;
            transform: translate(-69%, -69%); /* -69%にすると文字盤が "いい感じ" になった。 */
            text-align: center;
            font-size: 1.5rem;
            font-weight: 500;
            width: 40px;
            height: 40px;
            line-height: 40px;
            transition: color 0.3s;
        }
        /* ドラッグ不可の選択を無効化 */
        .no-select {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard */
        }
        /* input[type="time"] のスタイル */
        input[type="time"].font-digital {
            font-family: 'BIZ UD Gothic', sans-serif;
        }
        /* スクロールバーのスタイル */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        .dark::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #334155; /* slate-700 */
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800 dark:bg-gray-900 dark:text-slate-200 flex flex-col items-center justify-center min-h-screen p-4 no-select pb-24">

    <!-- 左上の現在時刻デジタル時計。デジタルなので24時間表示にした -->
    <div id="real-time-clock-container" class="fixed top-4 left-4 z-50">
        <div id="real-time-clock" class="font-digital text-2xl md:text-3xl backdrop-blur-sm p-3 rounded-lg shadow-lg cursor-pointer transition-all duration-300 bg-white text-gray-800 border border-black hover:bg-slate-100 dark:bg-black/30 dark:text-cyan-400 dark:border-white dark:hover:bg-black/50" title="クリックして表示/非表示を切り替える">
            00:00:00
        </div>
        <!-- マスクと表示ボタン -->
        <div id="real-time-mask" class="hidden fixed top-4 left-4 z-50 bg-slate-100/80 dark:bg-gray-900/80 backdrop-blur-sm rounded-lg cursor-pointer">
            <div class="bg-slate-300/50 dark:bg-slate-600/20 text-slate-700 dark:text-slate-200 px-4 py-2 rounded-full flex items-center justify-center whitespace-nowrap m-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <span class="ml-2">表示</span>
            </div>
        </div>
    </div>
    
    <!-- 右上のテーマ切り替えボタン -->
    <div class="fixed top-4 right-4 z-50">
        <button id="theme-toggle-btn" class="p-2 rounded-full bg-white/50 hover:bg-white/70 text-slate-800 dark:bg-slate-700/50 dark:hover:bg-slate-600/70 dark:text-slate-300 transition-colors">
            <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
            <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class=""><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
        </button>
    </div>


    <!-- スケール用ラッパー -->
    <div style="transform: scale(0.85);">
        <!-- メインコンテンツエリア -->
        <div class="flex flex-col items-center justify-center w-full max-w-4xl">

            <!-- アナログ時計 -->
            <div id="analog-clock" class="relative w-[300px] h-[300px] sm:w-[400px] sm:h-[400px] md:w-[500px] md:h-[500px] bg-white border-8 border-gray-300 dark:bg-gray-800 dark:border-slate-700 rounded-full shadow-2xl flex items-center justify-center cursor-grab active:cursor-grabbing mb-6 transition-colors duration-300">
                <!-- 中心点 -->
                <div id="clock-center" class="absolute w-4 h-4 bg-gray-800 border-2 border-white dark:bg-slate-200 dark:border-gray-900 rounded-full z-20 transition-colors duration-300"></div>
                <!-- 針 -->
                <div id="hour-hand" class="hand-transition absolute w-2 h-[22%] bg-gray-700 dark:bg-slate-300 rounded-t-full bottom-1/2 origin-bottom z-10 transition-colors duration-300"></div>
                <div id="minute-hand" class="hand-transition absolute w-1.5 h-[35%] bg-gray-700 dark:bg-slate-200 rounded-t-full bottom-1/2 origin-bottom z-10 transition-colors duration-300"></div>
                <div id="second-hand" class="hand-transition absolute w-0.5 h-[40%] bg-red-500 bottom-1/2 origin-bottom z-10"></div>
            </div>
            
            <!-- コントロールパネル -->
            <div id="control-panel" class="bg-white/50 dark:bg-gray-800/50 backdrop-blur-md p-6 rounded-2xl shadow-lg w-full max-w-md transition-colors duration-300">
                 <!-- 経過時間表示 -->
                <div class="mb-6">
                    <div id="elapsed-time-display" class="w-full text-center text-lg font-bold py-3 rounded-lg bg-slate-200 text-gray-700 dark:bg-slate-700 dark:text-slate-300 transition-colors duration-300 font-digital">
                        経過時間: 00:00:00
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
                    <div>
                        <label for="preset-select" class="control-label block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1 transition-colors duration-300">試験プリセット</label>
                        <select id="preset-select" class="control-input w-full bg-white border-gray-300 text-gray-800 dark:bg-gray-700 dark:border-gray-600 dark:text-slate-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none transition">
                            <option value="custom">カスタム</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label for="start-time" class="control-label block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1 transition-colors duration-300">開始</label>
                            <input type="time" id="start-time" value="09:00" class="control-input font-digital w-full bg-white border-gray-300 text-gray-800 dark:bg-gray-700 dark:border-gray-600 dark:text-slate-200 rounded-lg px-2 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none transition">
                        </div>
                        <div>
                            <label for="end-time" class="control-label block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1 transition-colors duration-300">終了</label>
                            <input type="time" id="end-time" value="10:30" class="control-input font-digital w-full bg-white border-gray-300 text-gray-800 dark:bg-gray-700 dark:border-gray-600 dark:text-slate-200 rounded-lg px-2 py-2 focus:ring-2 focus:ring-cyan-500 focus:outline-none transition">
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="start-reset-btn" class="w-full text-lg font-bold py-3 rounded-lg transition-all duration-300 ease-in-out bg-cyan-600 text-white hover:bg-cyan-500 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-cyan-500 focus:ring-opacity-50">
                        試験開始
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- アラーム音 -->
    <audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

    <!-- アラームモーダル -->
    <div id="alarm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[60] flex items-center justify-center p-4">
        <div id="alarm-modal-content" class="bg-white dark:bg-gray-800 rounded-2xl p-8 text-center shadow-2xl max-w-sm w-full transition-colors duration-300">
            <h2 class="text-4xl font-bold text-red-500 mb-4 animate-pulse">試験終了！</h2>
            <p id="alarm-modal-text" class="text-gray-700 dark:text-slate-300 mb-6 transition-colors duration-300">お疲れ様でした。</p>
            <button id="close-alarm-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition">閉じる</button>
        </div>
    </div>
    
    <!-- 準備時間設定パネル -->
    <div id="ready-time-panel" class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm p-3 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] dark:shadow-[0_-2px_10px_rgba(0,0,0,0.3)] transition-colors duration-300">
        <div class="max-w-md mx-auto flex items-center justify-center gap-4">
            <label class="control-label font-medium text-slate-600 dark:text-slate-300 whitespace-nowrap">準備時間:</label>
            <div class="flex items-center gap-2">
                <input type="number" id="ready-minutes" min="0" max="59" value="0" class="control-input font-digital w-20 text-center bg-white border-gray-300 text-gray-800 dark:bg-gray-700 dark:border-gray-600 dark:text-slate-200 rounded-lg px-2 py-1 focus:ring-2 focus:ring-cyan-500 focus:outline-none transition">
                <span class="control-label text-slate-600 dark:text-slate-300">分</span>
                <input type="number" id="ready-seconds" min="0" max="59" value="10" class="control-input font-digital w-20 text-center bg-white border-gray-300 text-gray-800 dark:bg-gray-700 dark:border-gray-600 dark:text-slate-200 rounded-lg px-2 py-1 focus:ring-2 focus:ring-cyan-500 focus:outline-none transition">
                <span class="control-label text-slate-600 dark:text-slate-300">秒</span>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM要素の取得 ---
            const htmlEl = document.documentElement;
            const realTimeClock = document.getElementById('real-time-clock');
            const realTimeMask = document.getElementById('real-time-mask');
            const analogClock = document.getElementById('analog-clock');
            const hourHand = document.getElementById('hour-hand');
            const minuteHand = document.getElementById('minute-hand');
            const secondHand = document.getElementById('second-hand');
            const presetSelect = document.getElementById('preset-select');
            const startTimeInput = document.getElementById('start-time');
            const endTimeInput = document.getElementById('end-time');
            const startResetBtn = document.getElementById('start-reset-btn');
            const alarmSound = document.getElementById('alarm-sound');
            const alarmModal = document.getElementById('alarm-modal');
            const closeAlarmBtn = document.getElementById('close-alarm-btn');
            const elapsedTimeDisplay = document.getElementById('elapsed-time-display');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const readyMinutesInput = document.getElementById('ready-minutes');
            const readySecondsInput = document.getElementById('ready-seconds');

            // --- 状態管理 ---
            let timerInterval = null;
            let isTimerRunning = false;
            let isDragging = false;
            let totalDurationSeconds = 0;
            let elapsedSeconds = 0;
            let clockStartTime = { h: 9, m: 0 };
            let currentTheme = 'dark'; // 'dark' or 'light'
            
            // --- 試験プリセットデータ ---
            const presets = {
                '電工二種・技能試験': { start: '11:30', end: '12:10' },
            };

            // --- 初期化処理 ---
            function initialize() {
                for (const name in presets) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    presetSelect.appendChild(option);
                }
                drawClockFace();
                updateClockFromInputs();
                setInterval(updateRealTime, 1000);
                updateRealTime();
                
                const savedTheme = localStorage.getItem('exam-timer-theme') || 'light';
                setTheme(savedTheme);
            }

            // --- 時計の文字盤描画 ---
            function drawClockFace() {
                const radius = analogClock.offsetWidth / 2 * 0.85;
                for (let i = 1; i <= 12; i++) {
                    const numberDiv = document.createElement('div');
                    numberDiv.className = 'clock-number text-slate-600 dark:text-slate-300';
                    const angle = i * 30 * Math.PI / 180;
                    const x = analogClock.offsetWidth / 2 + radius * Math.sin(angle);
                    const y = analogClock.offsetHeight / 2 - radius * Math.cos(angle);
                    numberDiv.style.left = `${x}px`;
                    numberDiv.style.top = `${y}px`;
                    numberDiv.textContent = i;
                    analogClock.appendChild(numberDiv);
                }
            }

            // --- テーマ切り替え ---
            function setTheme(theme) {
                currentTheme = theme;
                localStorage.setItem('exam-timer-theme', theme);
                const isDark = theme === 'dark';

                sunIcon.classList.toggle('hidden', isDark);
                moonIcon.classList.toggle('hidden', !isDark);
                htmlEl.classList.toggle('dark', isDark);
            }
            
            themeToggleBtn.addEventListener('click', () => {
                setTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });

            // --- 時刻・タイマー関連のロジック ---
            function updateRealTime() {
                realTimeClock.textContent = new Date().toLocaleTimeString('ja-JP', { hour12: false });
            }

            realTimeClock.addEventListener('click', () => {
                realTimeClock.classList.add('hidden');
                realTimeMask.classList.remove('hidden');
            });

            realTimeMask.addEventListener('click', () => {
                realTimeClock.classList.remove('hidden');
                realTimeMask.classList.add('hidden');
            });

            presetSelect.addEventListener('change', (e) => {
                const selectedPreset = e.target.value;
                if (presets[selectedPreset]) {
                    startTimeInput.value = presets[selectedPreset].start;
                    endTimeInput.value = presets[selectedPreset].end;
                }
                updateClockFromInputs();
                if(isTimerRunning) resetTimer();
            });

            [startTimeInput, endTimeInput, readyMinutesInput, readySecondsInput].forEach(input => {
                input.addEventListener('change', () => {
                    if (input !== readyMinutesInput && input !== readySecondsInput) {
                        presetSelect.value = 'custom';
                    }
                    updateClockFromInputs();
                    if(isTimerRunning) resetTimer();
                });
            });

            function updateClockHands(currentElapsedSeconds) {
                const currentSecond = Math.floor(currentElapsedSeconds % 60);

                if (currentSecond === 0 && secondHand.style.transition !== 'none') {
                    secondHand.style.transition = 'none';
                } else if (currentSecond !== 0 && secondHand.style.transition === 'none') {
                    secondHand.style.transition = ''; 
                }

                const totalMinutes = (clockStartTime.h * 60 + clockStartTime.m) + (currentElapsedSeconds / 60);
                const currentHour = Math.floor(totalMinutes / 60) % 24;
                const currentMinute = Math.floor(totalMinutes % 60);
                
                const secondDeg = (currentSecond / 60) * 360;
                const minuteDeg = ((currentMinute + currentSecond / 60) / 60) * 360;
                const hourDeg = ((currentHour % 12 + currentMinute / 60) / 12) * 360;
                
                secondHand.style.transform = `rotate(${secondDeg}deg)`;
                minuteHand.style.transform = `rotate(${minuteDeg}deg)`;
                hourHand.style.transform = `rotate(${hourDeg}deg)`;
            }
            
            function updateClockFromInputs() {
                const [startH, startM] = startTimeInput.value.split(':').map(Number);
                clockStartTime = { h: startH, m: startM };
                elapsedSeconds = 0;
                updateClockHands(elapsedSeconds);
            }

            function startTimer() {
                const [startH, startM] = startTimeInput.value.split(':').map(Number);
                const [endH, endM] = endTimeInput.value.split(':').map(Number);
                totalDurationSeconds = (endH * 3600 + endM * 60) - (startH * 3600 + startM * 60);

                if (totalDurationSeconds <= 0) {
                    const customAlert = document.createElement('div');
                    customAlert.className = 'fixed top-5 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-pulse';
                    customAlert.textContent = '終了時刻は開始時刻より後に設定してください。';
                    document.body.appendChild(customAlert);
                    setTimeout(() => customAlert.remove(), 3000);
                    resetTimer();
                    return;
                }
                
                const readyMinutes = parseInt(readyMinutesInput.value) || 0;
                const readySecondsValue = parseInt(readySecondsInput.value) || 0;
                const readyTimeInSeconds = readyMinutes * 60 + readySecondsValue;
                
                elapsedSeconds = -readyTimeInSeconds;

                alarmSound.load();
                isTimerRunning = true;
                setInputsDisabled(true);
                startResetBtn.textContent = 'リセット';
                startResetBtn.classList.replace('bg-cyan-600', 'bg-orange-600');
                startResetBtn.classList.replace('hover:bg-cyan-500', 'hover:bg-orange-500');
                
                updateClockHands(elapsedSeconds); // 準備時間分、時計を進める

                timerInterval = setInterval(() => {
                    elapsedSeconds++;
                    updateClockHands(elapsedSeconds);
                    
                    if (elapsedSeconds >= 0) {
                        const hours = Math.floor(elapsedSeconds / 3600);
                        const minutes = Math.floor((elapsedSeconds % 3600) / 60);
                        const seconds = elapsedSeconds % 60;
                        elapsedTimeDisplay.textContent = `経過時間: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    } else {
                        const remainingReadySeconds = -elapsedSeconds;
                        const minutes = Math.floor(remainingReadySeconds / 60);
                        const seconds = remainingReadySeconds % 60;
                        elapsedTimeDisplay.textContent = `準備時間: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }


                    if (elapsedSeconds >= totalDurationSeconds) {
                        finishTimer();
                    }
                }, 1000);
            }

            function resetTimer() {
                clearInterval(timerInterval);
                isTimerRunning = false;
                elapsedSeconds = 0;
                updateClockFromInputs();
                setInputsDisabled(false);
                startResetBtn.textContent = '試験開始';
                startResetBtn.classList.replace('bg-orange-600', 'bg-cyan-600');
                startResetBtn.classList.replace('hover:bg-orange-500', 'hover:bg-cyan-500');
                elapsedTimeDisplay.textContent = '経過時間: 00:00:00';
            }
            
            function finishTimer() {
                clearInterval(timerInterval);
                isTimerRunning = false;
                alarmSound.play().catch(e => console.error("Audio play failed:", e));
                alarmModal.classList.remove('hidden');
            }
            
            closeAlarmBtn.addEventListener('click', () => {
                alarmModal.classList.add('hidden');
                alarmSound.pause();
                alarmSound.currentTime = 0;
                resetTimer();
            });

            startResetBtn.addEventListener('click', () => {
                isTimerRunning ? resetTimer() : startTimer();
            });
            
            function setInputsDisabled(disabled) {
                [presetSelect, startTimeInput, endTimeInput, readyMinutesInput, readySecondsInput].forEach(el => el.disabled = disabled);
            }

            // --- Mouse/Touch Drag Logic  ---
            function handleDragStart(e) {
                if (isTimerRunning) return;
                isDragging = true;
                [hourHand, minuteHand, secondHand].forEach(hand => hand.classList.remove('hand-transition'));
                updateTimeFromEvent(e);
            }

            function handleDragMove(e) {
                if (!isDragging) return;
                updateTimeFromEvent(e);
            }

            function handleDragEnd() {
                if (isDragging) {
                    isDragging = false;
                    [hourHand, minuteHand, secondHand].forEach(hand => hand.classList.add('hand-transition'));
                }
            }

            analogClock.addEventListener('mousedown', handleDragStart);
            window.addEventListener('mousemove', handleDragMove);
            window.addEventListener('mouseup', handleDragEnd);
            
            analogClock.addEventListener('touchstart', (e) => { e.preventDefault(); handleDragStart(e.touches[0]); }, { passive: false });
            window.addEventListener('touchmove', (e) => { if(isDragging) handleDragMove(e.touches[0]); });
            window.addEventListener('touchend', handleDragEnd);

            function updateTimeFromEvent(e) {
                const rect = analogClock.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const dx = e.clientX - centerX;
                const dy = e.clientY - centerY;
                let angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                if (angle < 0) angle += 360;
                
                const newMinuteOnDial = Math.round(angle / 6) % 60;

                let [currentHour, currentMinute] = startTimeInput.value.split(':').map(Number);
                
                if (currentMinute > 45 && newMinuteOnDial < 15) {
                    currentHour = (currentHour + 1) % 24;
                } else if (currentMinute < 15 && newMinuteOnDial > 45) {
                    currentHour = (currentHour - 1 + 24) % 24;
                }
                
                const finalHour = String(currentHour).padStart(2, '0');
                const finalMinute = String(newMinuteOnDial).padStart(2, '0');
                
                startTimeInput.value = `${finalHour}:${finalMinute}`;
                presetSelect.value = 'custom';
                updateClockFromInputs();
            }

            initialize();
        });
    </script>
</body>
</html>

